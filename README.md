# Lifebit Challenge

## Goals
<details>
<summary>All goals list</summary>

### Main objetives
- [x] Design and describe the stack for this application.
  - [x] Draw or Schema.
- [x] Implement code to deploy the application.
- [x] Implement code to scale the number of replicas of the service based on the usage of the resources.
- [x] Implement code to simulate load.

### Requirements
- [x] Application must be public on the internet and accessible on port 80.
- [ ] The solution should be fault tolerance with high availability.
- [x] Use AWS as the cloud provider, but only free-tier resources are allowed.
- [x] The solution should be easy to manage/maintain.
- [ ] ~~Deliver all code/documentation required to deploy the infrastructure and the application in compressed file~~
  - [x] GitHub repository.

### Optionals
- [x] Provide a repository of a Control Version System like Github/Gitlab/Bitbucket instead of the previous compressed file.
- [x] Application is deployed when provision is happening.
- [ ] The solution can be up and running by executing a single command/script.
  - The solution need a pre-flight steps to initialize Terraform backend, after than a simple command will deploy all.
- [x] Management access (SSH or RDP) to the servers are allowed only for restricted IPs.
  - Manage server are unnecessary all happened automatically.
- [x] Application logs are centralised on a different service
  - Cloudwatch at logs storage.
- [x] Design and implement a process for deploying new application versions with no downtime.
</details>

## Requirements
### Mandatory
- IaC
  - [Terraform](https://developer.hashicorp.com/terraform/install "Install Terraform")
  - [Terragrunt](https://terragrunt.gruntwork.io/docs/getting-started/install/ "Install Terragrunt")
- To package the application
  - [Docker](https://docs.docker.com/get-docker/ "Install Docker")

### Optional
- To make your life easier
  - [Make](https://www.gnu.org/software/make/ "Make documentation")
  - [terraform-docs](https://terraform-docs.io/user-guide/installation/ "Install terraform-docs")

- To perform load tests
  - [K6](https://k6.io/docs/get-started/installation/ "Install K6")

## Design
All the architecture for this project are industrial standards in AWS.

### VPC
Usage of public/private subnet architecture:  
![VPC diagram](https://docs.aws.amazon.com/images/vpc/latest/userguide/images/public-nat-gateway-diagram.png)

An exception is added in this architecture to ensure the free tier. The private subnet need a NAT gateway in order to 
communicate outside the VPC. This part was removed and deployed the necessary nodes in the public subnets.

### ECS
ECS was implemented with EC2 instances avoiding Fargate.  
![ECS diagram](https://docs.aws.amazon.com/images/AmazonECS/latest/userguide/images/overview-fargate.png)

### General data path
![ECS diagram](https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/17/nlbECS_1.png)

The only exception with this official diagram is the internet traffic is plain instead of TLS.
TLS in the load balancer was intentionally not implemented.

## Usage
### Terraform setup
This step is necessary to make a reliable backend for Terraform with Terraform.  
**This step is only necessary one time in the life of the project.**

1. Comment the `remote_state` block in `IaC/Environments/terragrunt.hcl`.
2. Run `terragrunt apply` inside `Iac/Environments/eu-west-1/Common/terraform-setup`.
3. At this moment a `terraform.tfstate` will be generated in your local folder.
4. Copy this file to the s3 bucket generated with this Terragrunt launch in the path: `Iac/Environments/eu-west-1/Common/terraform-setup`.
5. Uncomment the block commented in the step 1.
6. Change the bucket name in the `config` section for the `remote_state` in the `IaC/Environments/terragrunt.hcl` (same as step 1) with the name generated by Terraform (the real bucket name).
7. Execute the step 2 again and verify no changes for Terraform

### Deploy
#### IaC
> `make deploy-all` :stuck_out_tongue_winking_eye:

*(Check the [Makefile](Makefile) if you are interested in what commands are executed).*

You can check the URL of the app with:
> `make get-dns`

#### The application
> `git push` to main branch :stuck_out_tongue_winking_eye:

*A GitHub workflow will do the hard job for you.*

#### Load test
> `make load-test` :stuck_out_tongue_winking_eye:

## Additional notes
All the Terraform modules made for this repository are portables and can migrate or import to any project directly.
